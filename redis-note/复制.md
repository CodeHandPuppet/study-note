### Redis 复制

#### 介绍

- 主从复制
    - **master**以写为主，**slave**以读为主（不可以写）。
    - 当**master**数据发生变化时，自动将新的数据**异步**同步到其他的**slave**上。
- 读写分离
- down机恢复
- 数据备份
- 数据备份
- 水平扩容支持**高并发**

#### 基本命令

``` txt
info replication   查看复制节点的主从关系和配置信息
    
replicaof/slaveof 主库IP 主库端口   replicaof/slaveof这两个一样，一般写入进redis.conf配置文件内，在运行期间修改slave节点的信息，如果该数据库已经某个数据库的从数据库，那么会停止和原主数据库的同步关系转而和新的主数据库同步

replicaof/slaveof no one      使当前数据库停止与其他数据库的同步，升级为主数据库

```

###### 操作
1. 配置文件操作
   - 主机和从机都需要配置

       ``` conf
       # - 
           daemonize yes

       # - 注释掉 bind 127.0.0.1 -::1

       # -  
           protected-mode no

       # - 指定端口号
           port 6379
       # - 指定当前的工作目录 
           dir /myredis

       # - pid文件的pidfile 
           pidfile "var/run/redis_6379.pid"

       # - log文件的名字
           logfile "/myredis/6379.log"

       # - 别人连接我的密码
           requirepass "123456"

       # - rdb 文件的名字
           dbfilename "dump.rdb"

       # - 开启 aof
           appendonly yes
           appendfilename "appendonly.aof"
       ```
   - 从机上配置
     ``` conf
       #指定 主机
        replicaof masterIP masterPort
       # 主机需要验证的密码
        masterauth "123456"
     ```
     - Tip:注意防火墙配置
       ```shell
           启动： systemctl start firewalld
           关闭： systemctl stop firewalld
           查看状态： systemctl status firewalld 
           开机禁用  ： systemctl disable firewalld
           开机启用  ： systemctl enable firewalld
           添加 ：firewall-cmd --zone=public --add-port=80/tcp --permanent    （--permanent永久生效，没有此参数重启后失效）
           重新载入： firewall-cmd --reload
           查看： firewall-cmd --zone= public --query-port=80/tcp
           删除： firewall-cmd --zone= public --remove-port=80/tcp --permanent
       ```
2. 命令操作

- 命令操作手动指定
  - 去掉配置文件中配置的从属关系
  - replicaof/slaveof no one 升级为主机
  - replicaof/slaveof 主库IP 主库端口 称为主库的从机
  - 配置VS命令的区别
    - 配置，持久稳定
    - 命令，当次生效
  

#### 总结
1. 特性
   - 薪火相传
       > 上一个slave可以是下一个slave的master，slave同样可以接收其他slaves的连接和同步请求，那么该slave作为了链条中下一个的master，可以有效减>轻主master的写压力
       > 中途变更转向：会清除之前的数据，重新建立拷贝最新的slaveof/replicaof 新主库IP 新主库端口
   - 反客为主
       > slaveof/replicaof no one 使当前数据库停止与其他数据库的同步，转成主数据库

2. 复制原理
   - slave启动，同步初请
       - slave启动成功连接到master后会发送一个sync命令
       - slave首次全新连接master，一次完全同步（全量复制）将被自动执行，slave自身原有数据会被master数据覆盖清除
   - 首次连接，全量复制
       - master节点收到sync命令后会在后台开始保存快照（即RDB持久化，主从复制会触发RDB），同时收集所有接收到的用于修改数据集命令缓存起来，master节点执行RDB持久化后，master将rdb快照文件和缓存的命令发送到所有slave，已完成一次完全同步
     - 而slave服务在接收到数据库文件数据后，将其存盘并加载到内存中，从而完成复制初始化
   - 心跳持续，保持通信
       - repl-ping-replica-period 10
       - master发出PING包的周期，默认是10秒
   - 进入平稳，增量复制
     - master 继续将新的所有收集到的修改命令自动一次传给slave，完成同步
   - 从机下线，重连续传
     - master 会检查backlog里面的offset，master和slave都会保存一个复制的offset怀有一个masterId
     - offset 是保存在backlog 中的。master只会把已经复制的offset后面的数据赋值给slave，类似断电续传

3. 缺点
    - 复制延时，信号衰减
        > 由于所有的写操作都是先在Master上操作，然后同步更新到Slave上，所以从Master同步到Slave机器有一定的延迟，当系统很繁忙的时候，延迟问题会更加严重，Slave机器数量的增加也会使这个问题更加严重。
    - master挂了
      - 默认情况下不会在slave节点自动重选一个master
      - 需要人工干预